<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股籌碼戰情室</title>
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js (Logic) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Chart.js (Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Segoe UI', Microsoft JhengHei, sans-serif; }
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800" x-data="app()">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer" @click="tab='inst'">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <h1 class="text-xl font-bold tracking-wide">台股籌碼戰情室</h1>
            </div>
            
            <!-- Navigation -->
            <nav class="flex flex-wrap justify-center bg-slate-800 p-1 rounded-lg gap-1">
                <button @click="tab = 'inst'" :class="{'bg-blue-600 text-white shadow': tab === 'inst', 'text-slate-400 hover:text-white': tab !== 'inst'}" class="px-3 py-1.5 md:px-4 md:py-2 rounded-md text-sm font-medium transition-all">三大法人</button>
                <button @click="tab = 'broker'" :class="{'bg-blue-600 text-white shadow': tab === 'broker', 'text-slate-400 hover:text-white': tab !== 'broker'}" class="px-3 py-1.5 md:px-4 md:py-2 rounded-md text-sm font-medium transition-all">券商分點</button>
                <button @click="tab = 'cost'" :class="{'bg-purple-600 text-white shadow': tab === 'cost', 'text-slate-400 hover:text-white': tab !== 'cost'}" class="px-3 py-1.5 md:px-4 md:py-2 rounded-md text-sm font-medium transition-all flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    主力成本
                </button>
                <button @click="tab = 'stock'" :class="{'bg-blue-600 text-white shadow': tab === 'stock', 'text-slate-400 hover:text-white': tab !== 'stock'}" class="px-3 py-1.5 md:px-4 md:py-2 rounded-md text-sm font-medium transition-all">個股搜尋</button>
                <!-- NEW: Integrated Analysis Tool -->
                <button @click="tab = 'analysis'" :class="{'bg-yellow-600 text-white shadow': tab === 'analysis', 'text-slate-400 hover:text-white': tab !== 'analysis'}" class="px-3 py-1.5 md:px-4 md:py-2 rounded-md text-sm font-medium transition-all flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    進階分析 (AI)
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-2 md:p-6 pb-20">

        <!-- Error Message -->
        <div x-show="error" x-cloak class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
            <strong class="font-bold">讀取錯誤！</strong>
            <span class="block sm:inline" x-text="error"></span>
            <p class="text-xs mt-1">請確認是否已執行 Python 腳本並產生 data 資料夾，且使用 http.server 開啟。</p>
        </div>

        <!-- TAB 1: Institutional (三大法人) -->
        <div x-show="tab === 'inst'" x-transition>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">法人籌碼排行</h2>
                <div class="flex bg-white border border-slate-200 rounded-lg p-1">
                    <template x-for="d in [5, 20, 60, 120]">
                        <button @click="windowDays = d; fetchInstRank()" 
                            :class="{'bg-blue-100 text-blue-700 font-bold': windowDays === d, 'text-slate-500 hover:bg-slate-50': windowDays !== d}"
                            class="px-3 py-1 text-sm rounded-md transition-colors" x-text="d + '日'"></button>
                    </template>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Top Up -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-red-50/50 border-b border-red-100 font-bold text-red-800 flex justify-between">
                        <span>法人買超佔比增加 (Top 50)</span>
                        <span class="text-xs font-normal opacity-70">點擊查看個股</span>
                    </div>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 sticky top-0">
                                <tr><th class="px-4 py-2">代碼</th><th class="px-4 py-2">名稱</th><th class="px-4 py-2 text-right">佔比%</th><th class="px-4 py-2 text-right">變動%</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="item in instRank.up">
                                    <tr @click="loadStock(item.code)" class="hover:bg-slate-50 cursor-pointer transition">
                                        <td class="px-4 py-3 font-mono text-slate-600" x-text="item.code"></td>
                                        <td class="px-4 py-3 font-bold" x-text="item.name"></td>
                                        <td class="px-4 py-3 text-right" x-text="formatNum(item.three_inst_ratio)"></td>
                                        <td class="px-4 py-3 text-right font-bold text-red-600" x-text="'+' + formatNum(item.change)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div x-show="instRank.up.length === 0" class="p-8 text-center text-slate-400">無資料 (請確認 JSON 檔案存在)</div>
                    </div>
                </div>
                <!-- Top Down -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-green-50/50 border-b border-green-100 font-bold text-green-800 flex justify-between">
                        <span>法人賣超佔比減少 (Top 50)</span>
                        <span class="text-xs font-normal opacity-70">點擊查看個股</span>
                    </div>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 sticky top-0">
                                <tr><th class="px-4 py-2">代碼</th><th class="px-4 py-2">名稱</th><th class="px-4 py-2 text-right">佔比%</th><th class="px-4 py-2 text-right">變動%</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="item in instRank.down">
                                    <tr @click="loadStock(item.code)" class="hover:bg-slate-50 cursor-pointer transition">
                                        <td class="px-4 py-3 font-mono text-slate-600" x-text="item.code"></td>
                                        <td class="px-4 py-3 font-bold" x-text="item.name"></td>
                                        <td class="px-4 py-3 text-right" x-text="formatNum(item.three_inst_ratio)"></td>
                                        <td class="px-4 py-3 text-right font-bold text-green-600" x-text="formatNum(item.change)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Broker (券商分點) -->
        <div x-show="tab === 'broker'" x-cloak x-transition>
            <div class="space-y-6">
                <!-- Target Brokers -->
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">主力券商今日動向 (重點監控)</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="(trades, broker) in targetTrades" :key="broker">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 hover:border-blue-300 transition cursor-pointer" @click="loadBrokerTrend(broker)">
                                <div class="flex justify-between items-center mb-3 border-b border-slate-50 pb-2">
                                    <h3 class="font-bold text-lg text-slate-800" x-text="broker"></h3>
                                    <span class="text-xs text-blue-500">查看趨勢 &rarr;</span>
                                </div>
                                <div class="space-y-2">
                                    <template x-for="t in trades.slice(0, 5)">
                                        <div class="flex justify-between text-sm">
                                            <div class="flex items-center gap-2">
                                                <span class="px-1.5 py-0.5 rounded text-xs font-medium" :class="t.side === 'buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'" x-text="t.side==='buy'?'買':'賣'"></span>
                                                <span x-text="t.stock_code"></span>
                                            </div>
                                            <span class="font-mono font-bold" :class="t.net_vol > 0 ? 'text-red-600' : 'text-green-600'" x-text="(t.net_vol>0?'+':'')+t.net_vol"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <div x-show="Object.keys(targetTrades).length === 0" class="col-span-3 text-center text-slate-400 py-10 bg-white rounded-xl">無重點券商資料 (請檢查 target_broker_trades.json)</div>
                    </div>
                </div>

                <!-- Broker Ranking & Trend -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-[450px] flex flex-col">
                        <div class="p-4 bg-slate-50 font-bold border-b border-slate-100">本日全市場券商排行</div>
                        <div class="overflow-y-auto flex-1">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 sticky top-0 text-slate-500"><tr><th class="px-4 py-2 text-left">券商</th><th class="px-4 py-2 text-right">總買賣超</th></tr></thead>
                                <tbody>
                                    <template x-for="b in brokerRanking">
                                        <tr class="border-b hover:bg-slate-50">
                                            <td class="px-4 py-2" x-text="b.broker_name"></td>
                                            <td class="px-4 py-2 text-right font-mono font-bold" :class="b.total_net_vol > 0 ? 'text-red-600' : 'text-green-600'" x-text="(b.total_net_vol>0?'+':'')+b.total_net_vol"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                         <h3 class="font-bold text-slate-700 mb-4" x-text="selectedBroker ? selectedBroker + ' - 累積買賣超趨勢 (30日)' : '請點擊左方或上方券商查看趨勢'"></h3>
                         <div class="relative h-[350px] w-full">
                            <canvas id="brokerChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Cost Analysis (主力成本) -->
        <div x-show="tab === 'cost'" x-cloak x-transition>
            <div class="space-y-6">
                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-purple-800">主力分點成本分析</h3>
                    <p class="text-sm text-purple-700 mt-1">此頁面顯示重點券商在特定個股上的「加權平均成本」與「股價」對照。資料來源於 <code>calculate_broker_cost.py</code>。</p>
                </div>

                <div x-show="Object.keys(costData).length === 0" class="text-center py-10 text-slate-400">
                    尚無成本分析資料，請確認是否執行 <code>python calculate_broker_cost.py</code> 並產生了 <code>broker_cost_analytics.json</code>。
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <template x-for="(data, key) in costData" :key="key">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                                <h3 class="font-bold text-lg text-slate-800">
                                    <span class="text-purple-600" x-text="data.broker"></span>
                                    <span class="mx-1 text-slate-300">/</span>
                                    <span x-text="data.stock"></span>
                                </h3>
                                <div class="text-xs text-slate-500" x-show="data.data && data.data.length > 0">
                                    現價: <span class="font-mono font-bold text-slate-800" x-text="data.data[data.data.length-1].price"></span>
                                    成本: <span class="font-mono font-bold text-purple-600" x-text="data.data[data.data.length-1].cost"></span>
                                </div>
                            </div>
                            <div class="h-[300px] w-full relative">
                                <canvas :id="'costChart_' + key" x-init="$nextTick(() => renderCostChart('costChart_' + key, data.data))"></canvas>
                            </div>
                            <div class="mt-2 flex justify-between text-xs text-slate-500 px-2" x-show="data.data && data.data.length > 0">
                                <span>最新庫存: <strong x-text="data.data[data.data.length-1].inventory"></strong> 張</span>
                                <span :class="data.data[data.data.length-1].price > data.data[data.data.length-1].cost ? 'text-red-500' : 'text-green-500'">
                                    獲利: <span x-text="((data.data[data.data.length-1].price / data.data[data.data.length-1].cost - 1) * 100).toFixed(1) + '%'"></span>
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- TAB 4: Stock Search (個股) -->
        <div x-show="tab === 'stock'" x-cloak x-transition>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 flex gap-4">
                <input type="text" x-model="searchCode" @keydown.enter="loadStock(searchCode)" placeholder="輸入代碼 (例如 2330)" class="border border-slate-300 rounded px-4 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="loadStock(searchCode)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">查詢</button>
            </div>

            <!-- Stock Charts Area -->
            <div x-show="stockData.length > 0" class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" x-text="currentStockName + ' (' + currentStockCode + ')'"></h2>
                        <div class="flex gap-4 text-sm">
                            <div class="text-slate-500">外資: <span class="font-bold text-blue-600" x-text="lastStockData.foreign_ratio + '%'"></span></div>
                            <div class="text-slate-500">投信: <span class="font-bold text-red-600" x-text="lastStockData.trust_ratio + '%'"></span></div>
                        </div>
                    </div>
                    <div class="h-[400px]">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg text-sm">
                    <strong>提示：</strong> 若要查看此股票的「分點進出明細」，請確認 Python 腳本有抓取該股的分點資料（預設只抓熱門股）。
                </div>
            </div>
            <div x-show="stockData.length === 0 && !loading" class="text-center text-slate-400 mt-10">請輸入代碼查詢</div>
        </div>

        <!-- TAB 5: Advanced Analysis (Embedded React App) NEW! -->
        <div x-show="tab === 'analysis'" x-cloak x-transition class="h-full">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-[calc(100vh-140px)] w-full">
                <!-- 嵌入 analysis.html，請確保該檔案存在於 docs/analysis.html -->
                <iframe src="analysis.html" title="台股分析工具" class="w-full h-full border-0"></iframe>
            </div>
            <p class="text-center text-xs text-slate-400 mt-2">進階分析工具由 React 提供，請確保 <code>analysis.html</code> 已上傳至 docs 資料夾。</p>
        </div>

    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                tab: 'inst',
                windowDays: 20,
                instRank: { up: [], down: [] },
                brokerRanking: [],
                targetTrades: {},
                brokerTrends: {},
                stockData: [],
                costData: {}, 
                searchCode: '2330',
                currentStockCode: '',
                currentStockName: '',
                selectedBroker: null,
                error: null,
                loading: false,
                charts: {},

                async init() {
                    await this.fetchInstRank();
                    this.fetchBrokerData();
                    this.fetchCostData();
                },

                formatNum(n) {
                    return n ? parseFloat(n).toFixed(1) : '0.0';
                },

                get lastStockData() {
                    return this.stockData.length > 0 ? this.stockData[this.stockData.length - 1] : {};
                },

                async fetchInstRank() {
                    this.loading = true;
                    try {
                        const [up, down] = await Promise.all([
                            fetch(`data/top_three_inst_change_${this.windowDays}_up.json`).then(res => res.ok ? res.json() : []),
                            fetch(`data/top_three_inst_change_${this.windowDays}_down.json`).then(res => res.ok ? res.json() : [])
                        ]);
                        this.instRank.up = up.slice(0, 100);
                        this.instRank.down = down.slice(0, 100);
                        this.error = null;
                    } catch (e) {
                        console.error(e);
                        // Silent fail for smoother UX, error message only on strict failure
                    }
                    this.loading = false;
                },

                async fetchBrokerData() {
                    try {
                        const rankRes = await fetch('data/broker_ranking.json');
                        if (rankRes.ok) this.brokerRanking = (await rankRes.json()).data || [];
                        
                        const targetRes = await fetch('data/target_broker_trades.json');
                        if (targetRes.ok) {
                            this.targetTrades = (await targetRes.json()).brokers || {};
                            const first = Object.keys(this.targetTrades)[0];
                            if(first) this.loadBrokerTrend(first);
                        }
                        
                        const trendRes = await fetch('data/broker_trends.json');
                        if (trendRes.ok) this.brokerTrends = (await trendRes.json()).brokers || {};
                    } catch (e) {
                        console.log("Broker data not found (optional)");
                    }
                },

                async fetchCostData() {
                    try {
                        const res = await fetch('data/broker_cost_analytics.json');
                        if (res.ok) {
                            this.costData = await res.json();
                        }
                    } catch (e) {
                        console.log("Cost analytics data not found");
                    }
                },

                async loadStock(code) {
                    this.tab = 'stock';
                    this.searchCode = code;
                    this.loading = true;
                    try {
                        const res = await fetch(`data/timeseries/${code}.json`);
                        if (!res.ok) throw new Error("Stock not found");
                        const data = await res.json();
                        this.stockData = data;
                        this.currentStockCode = code;
                        this.currentStockName = data[0]?.name || code;
                        this.renderStockChart();
                        this.error = null;
                    } catch (e) {
                        this.error = `找不到代碼 ${code} 的資料`;
                        this.stockData = [];
                    }
                    this.loading = false;
                },

                loadBrokerTrend(brokerName) {
                    this.selectedBroker = brokerName;
                    this.tab = 'broker';
                    this.renderBrokerChart(brokerName);
                },

                renderStockChart() {
                    const ctx = document.getElementById('stockChart');
                    if (!ctx) return;
                    if (this.charts.stock) this.charts.stock.destroy();

                    this.charts.stock = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.stockData.map(d => d.date),
                            datasets: [
                                { label: '外資持股%', data: this.stockData.map(d => d.foreign_ratio), borderColor: '#2563eb', backgroundColor: '#2563eb', yAxisID: 'y' },
                                { label: '投信持股%', data: this.stockData.map(d => d.trust_ratio), borderColor: '#dc2626', backgroundColor: '#dc2626', yAxisID: 'y' },
                                { label: '總持股%', data: this.stockData.map(d => d.three_inst_ratio), borderColor: '#7c3aed', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(124, 58, 237, 0.1)' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: { y: { beginAtZero: false } }
                        }
                    });
                },

                renderBrokerChart(brokerName) {
                    const ctx = document.getElementById('brokerChart');
                    if (!ctx) return;
                    if (this.charts.broker) this.charts.broker.destroy();

                    const trend = this.brokerTrends[brokerName] || [];
                    if (trend.length === 0) return;

                    this.charts.broker = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trend.map(d => d.date),
                            datasets: [{
                                label: '累積買賣超張數',
                                data: trend.map(d => d.cumulative),
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { title: { display: false } },
                            interaction: { mode: 'index', intersect: false }
                        }
                    });
                },

                renderCostChart(canvasId, data) {
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;
                    if (this.charts[canvasId]) this.charts[canvasId].destroy();

                    this.charts[canvasId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.date),
                            datasets: [
                                {
                                    type: 'line',
                                    label: '股價',
                                    data: data.map(d => d.price),
                                    borderColor: '#f59e0b',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    yAxisID: 'y'
                                },
                                {
                                    type: 'line',
                                    label: '預估成本',
                                    data: data.map(d => d.cost),
                                    borderColor: '#9333ea',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    yAxisID: 'y'
                                },
                                {
                                    type: 'bar',
                                    label: '庫存量(張)',
                                    data: data.map(d => d.inventory),
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: '價格' }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    grid: { drawOnChartArea: false },
                                    title: { display: true, text: '庫存量' }
                                }
                            }
                        }
                    });
                }
            }))
        })
    </script>
</body>
</html>